<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>健康知識小探險</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Changed to flex-start to allow scrolling from top */
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
        }
        #game-container {
            /* 背景圖片已移除 */
            background-image: none; /* 移除背景圖片 */
            background-color: #ffffff; /* 設定為白色背景 */
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 900px;
            width: 100%;
            padding: 2rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%; /* Changed from min-height to height */
            max-height: 90vh; /* Set a max height to enable scrolling within container */
            position: relative; /* For absolute positioning of internal elements */
            overflow-y: auto; /* Allow vertical scrolling within the game container if content overflows */
        }
        .screen {
            width: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1; /* Allow screens to take up available space */
            position: relative; /* Needed for any absolute positioning within screen */
        }
        .screen.active {
            display: flex;
        }
        /* Style for the content area on the start screen */
        .start-screen-content {
            background-color: rgba(255, 255, 255, 0.85); /* Semi-transparent white background */
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem; /* Space below content */
            width: 100%;
            max-width: 500px; /* Limit width for better readability */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            display: flex; /* Flexbox for centering content within */
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .btn {
            background-image: linear-gradient(to right, #6EE7B7 0%, #34D399  51%, #6EE7B7  100%);
            margin: 1rem 0.5rem;
            padding: 0.8rem 2rem;
            text-align: center;
            text-transform: uppercase;
            transition: 0.5s;
            background-size: 200% auto;
            color: white;
            border-radius: 0.75rem; /* More rounded */
            display: inline-block;
            font-weight: 700;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn:hover {
            background-position: right center; /* change the direction of the change here */
            color: #fff;
            text-decoration: none;
        }
        .option-btn {
            background-color: #e2e8f0; /* Lighter gray for options */
            color: #334155; /* Darker text */
            margin: 0.5rem 0;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            width: 100%;
            max-width: 500px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            text-align: left;
            border: 2px solid transparent;
            font-weight: 500;
        }
        .option-btn:hover {
            background-color: #cbd5e1; /* Slightly darker on hover */
            transform: translateY(-2px);
        }
        .option-btn.correct {
            background-color: #34D399; /* Green */
            color: white;
            border-color: #10B981;
        }
        .option-btn.incorrect {
            background-color: #EF4444; /* Red */
            color: white;
            border-color: #DC2626;
        }
        .submit-btn { /* Style for the new submit button */
            background-image: linear-gradient(to right, #F9A826 0%, #FBC02D 51%, #F9A826 100%);
            color: white;
            padding: 0.8rem 2rem;
            border-radius: 0.75rem;
            font-weight: 700;
            margin-top: 1rem; /* Space from options */
            cursor: pointer;
            transition: 0.5s;
            background-size: 200% auto;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
        }
        .submit-btn:hover {
            background-position: right center;
        }
        .character-card {
            background-color: #f8fafc;
            border-radius: 1rem;
            padding: 1.5rem;
            margin: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: left;
            width: 100%;
            max-width: 400px;
        }
        .character-card h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #10B981; /* Green heading */
            margin-bottom: 0.5rem;
        }
        .character-card p {
            color: #475569;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        .character-card .role {
            font-weight: 600;
            color: #2D3748; /* Darker gray */
            margin-bottom: 0.25rem;
        }
        #feedback-screen {
            text-align: center;
        }
        #feedback-screen h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
        }
        #feedback-message {
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }
        #explanation {
            background-color: #e0f2f7; /* Light blue for explanation */
            border-left: 5px solid #06B6D4; /* Cyan border */
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
            text-align: left;
            color: #083344;
        }
        #gemini-explanation-container {
            background-color: #fffbeb; /* Light yellow for Gemini explanation */
            border-left: 5px solid #F59E0B; /* Amber border */
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
            text-align: left;
            color: #78350F;
            display: none; /* Hidden by default */
        }
        #score-display {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1E40AF; /* Dark blue */
            margin-top: 1rem;
        }
        .character-icon {
            font-size: 3rem; /* Larger emoji */
            line-height: 1;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #34D399;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Bottom Navigation Buttons Styling */
        .bottom-nav-buttons-container {
            display: flex;
            justify-content: center;
            gap: 1.5rem; /* Space between buttons */
            margin-top: 2rem; /* Space from content above */
            width: 100%; /* Take full width for centering */
        }
        .nav-btn {
            background-color: #a0aec0; /* A neutral background */
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: background-color 0.3s;
            display: flex; /* Allow content to be centered */
            align-items: center;
            justify-content: center;
        }
        .nav-btn:hover {
            background-color: #718096; /* Darker on hover */
        }
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #cbd5e1; /* Lighter grey when disabled */
        }
        .view-score-btn { /* Style for the new "查看分數" button */
            background-image: linear-gradient(to right, #60A5FA 0%, #3B82F6 51%, #60A5FA 100%);
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .view-score-btn:hover {
            background-position: right center;
        }

        /* Audio controls styling */
        #audio-controls {
            display: flex;
            flex-direction: column; /* Stack controls vertically */
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
            padding: 1rem;
            background-color: #e2e8f0;
            border-radius: 0.75rem;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .audio-controls-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            width: 100%;
            justify-content: center; /* Center items in the row */
            flex-wrap: wrap; /* Allow items to wrap on smaller screens */
        }
        #audio-controls button {
            background-color: #4CAF50; /* Green */
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
            white-space: nowrap; /* Prevent button text from wrapping */
        }
        #audio-controls button:hover {
            background-color: #45a049;
        }
        #audio-controls input[type="range"] {
            flex-grow: 1; /* Allow slider to take more space */
            min-width: 100px; /* Minimum width for slider */
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
            border-radius: 4px;
        }
        #audio-controls input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #34D399;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #audio-controls input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #34D399;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #bgm-selector {
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid #cbd5e1;
            background-color: #f8fafc;
            color: #334155;
            font-size: 0.9rem;
            flex-grow: 1; /* Allow selector to take more space */
            min-width: 120px;
        }
        #progressSlider {
            width: 100%; /* Make progress slider full width of its container */
        }
        .time-display {
            font-size: 0.85rem;
            color: #64748b;
            white-space: nowrap; /* Prevent time from wrapping */
            min-width: 80px; /* Ensure enough space for time display */
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="game-container" class="flex flex-col items-center">

        <!-- Start Screen -->
        <div id="start-screen" class="screen active">
            <div class="start-screen-content">
                <h1 class="text-4xl font-bold text-gray-800 mb-6">歡迎來到健康知識小探險！</h1>
                <p class="text-lg text-gray-600 mb-8">在這裡，我們將認識一些重要的營養素，它們都是身體裡的「健康夥伴」喔！</p>
                <button class="btn" id="startGameBtn">開始遊戲</button>
                <button class="btn" id="renderCharactersBtn">認識健康夥伴</button>
            </div>
        </div>

        <!-- Character Info Screen -->
        <div id="characters-screen" class="screen">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">認識健康夥伴</h2>
            <div id="character-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Character cards will be injected here by JS -->
            </div>
            <button class="btn mt-8" id="backToHomeFromCharacters">返回首頁</button>
        </div>

        <!-- Question Screen -->
        <div id="question-screen" class="screen">
            <div id="score-display" class="mb-4">得分：0</div>
            <h2 id="question-text" class="text-2xl font-semibold text-gray-700 mb-6"></h2>
            <div id="options-container" class="flex flex-col items-center w-full">
                <!-- Options will be injected here by JS -->
            </div>
            <div class="bottom-nav-buttons-container">
                <button id="prev-question-nav-btn" class="nav-btn">&#x25C0; 上一題</button>
                <button id="back-to-home-from-question-btn" class="nav-btn">回到首頁</button> <!-- Added button -->
                <button id="next-question-nav-btn" class="nav-btn">下一題 &#x25B6;</button>
            </div>
        </div>

        <!-- Feedback Screen -->
        <div id="feedback-screen" class="screen">
            <h2 id="feedback-result" class="text-3xl font-bold mb-4"></h2>
            <p id="feedback-message" class="text-xl text-gray-600 mb-6"></p>
            <div id="explanation" class="w-full max-w-lg mb-4"></div>
            <button class="btn" id="learnMoreBtn">✨ 深入了解</button>
            <div id="gemini-explanation-container" class="w-full max-w-lg mt-4">
                <div class="loading-spinner" id="gemini-loading" style="display:none;"></div>
                <p id="gemini-explanation-text"></p>
            </div>
            <div class="bottom-nav-buttons-container">
                <button id="prev-feedback-nav-btn" class="nav-btn">&#x25C0; 上一題</button>
                <button id="next-feedback-nav-btn" class="nav-btn">下一題 &#x25B6;</button>
            </div>
        </div>

        <!-- End Screen -->
        <div id="end-screen" class="screen">
            <h2 class="text-4xl font-bold text-gray-800 mb-6">遊戲結束！</h2>
            <p id="final-score" class="text-2xl text-gray-700 mb-8">你的總分是：0</p>
            <button class="btn" id="resetGameBtn">再玩一次</button>
            <button class="btn" id="backToHomeFromEnd">回到首頁</button>
        </div>

        <!-- Background Music Audio Elements -->
        <!-- Note: To ensure audio plays correctly, it's recommended to use .mp3 or .wav files and provide stable, directly accessible links. -->
        <!-- If you have other audio links, please replace the src attributes below. -->
        <audio id="bgm-song1" loop>
            <source src="https://github.com/petroleum2024/heyyo/raw/main/Warriyo%2C%20LXNGVX%20-%20Mortals%20Funk%20Remix%20%5BNCS%20Release%5D.mp3" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
        <audio id="bgm-song2" loop>
            <source src="https://github.com/petroleum2024/heyyo/raw/main/6%E6%9C%888%E6%97%A5.mp4" type="video/mp4">
            Your browser does not support the audio element.
        </audio>
        <audio id="bgm-song3" loop>
            <source src="https://github.com/petroleum2024/heyyo/raw/main/6%E6%9C%888%E6%97%A5(2)%20-%20Compressed%20with%20FlexClip.mp4" type="video/mp4">
            Your browser does not support the audio element.
        </audio>

        <!-- Correct Answer Sound Effect -->
        <audio id="correct-sfx">
            <source src="https://github.com/petroleum2024/heyyo/raw/main/6%E6%9C%887%E6%97%A5.mp4" type="video/mp4">
        </audio>

        <!-- Incorrect Answer Sound Effect -->
        <audio id="incorrect-sfx">
            <source src="https://github.com/petroleum2024/heyyo/raw/main/%E9%8C%AF%E8%AA%A4.mp4" type="video/mp4">
        </audio>

        <!-- Audio Controls -->
        <div id="audio-controls">
            <div class="audio-controls-row">
                <select id="bgm-selector" class="p-2 rounded-md bg-gray-100 border border-gray-300">
                    <!-- Options will be populated by JS -->
                </select>
                <button id="playPauseBtn">❚❚ 暫停</button>
                <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.5">
            </div>
            <div class="audio-controls-row">
                <span id="currentTimeDisplay" class="time-display">00:00</span>
                <input type="range" id="progressSlider" min="0" max="0" step="0.1" value="0">
                <span id="durationDisplay" class="time-display">00:00</span>
            </div>
        </div>

    </div>

    <script>
        // Game data: questions, answers, explanations, and associated characters
        const gameData = [
            {
                question: "以下哪位健康夥伴負責製造甲狀腺荷爾蒙，對新陳代謝和生長發育至關重要？",
                options: ["鈉大俠", "碘小精靈", "鉀醫生", "鈣超人"],
                answer: "碘小精靈",
                explanation: "碘小精靈是甲狀腺荷爾蒙的關鍵成分。如果缺乏碘，可能會導致甲狀腺功能不足，影響身體的新陳代謝和兒童的生長發育，嚴重者可能出現甲狀腺腫大。",
                character: "碘小精靈"
            },
            {
                question: "哪位健康夥伴主要幫助身體維持體液平衡，但攝取過多可能導致血壓升高？",
                options: ["鈣超人", "鐵戰士", "鈉大俠", "維生素D寶寶"],
                answer: "鈉大俠",
                explanation: "鈉大俠是身體重要的電解質，幫助維持細胞內外的體液平衡、神經衝動傳導及肌肉正常收縮。然而，長期攝取過多的鈉（如鹽分），容易增加高血壓、水腫及心血管疾病的風險。",
                character: "鈉大俠"
            },
            {
                question: "哪位健康夥伴能與鈉大俠協同作用，幫助平衡血壓，並維持心臟和肌肉的正常功能？",
                options: ["鉀醫生", "磷巨人", "鎂魔法師", "鋅小隊長"],
                answer: "鉀醫生",
                explanation: "鉀醫生是鈉大俠的平衡者，兩者共同維護身體的體液和電解質平衡。足夠的鉀攝取有助於抵消鈉對血壓的影響，降低高血壓風險。同時，鉀也對心臟節律和肌肉收縮至關重要。",
                character: "鉀醫生"
            },
            {
                question: "如果身體缺乏「碘小精靈」，最可能出現哪種健康問題？",
                options: ["貧血", "骨質疏鬆", "甲狀腺腫大", "視力模糊"],
                answer: "甲狀腺腫大",
                explanation: "碘小精靈是甲狀腺製造荷爾蒙的必需品，如果缺乏碘，甲狀腺會代償性地增生變大，形成甲狀腺腫大（俗稱大脖子病）。在兒童時期缺乏更會影響智力和身體發育。",
                character: "碘小精靈"
            },
            {
                question: "為了平衡「鈉大俠」的影響，我們應該多攝取哪位健康夥伴？",
                options: ["鋅小隊長", "鎂魔法師", "鉀醫生", "鐵戰士"],
                answer: "鉀醫生",
                explanation: "多攝取富含鉀的食物（如蔬菜、水果、全穀類），有助於幫助身體排出多餘的鈉，從而達到平衡血壓的效果。鉀醫生是鈉大俠的好搭檔！",
                character: "鉀醫生"
            },
            {
                question: "哪位健康夥伴雖然不能被身體消化吸收，卻能幫助腸道蠕動，維持消化道健康？",
                options: ["維生素C仙子", "鐵戰士", "纖維小助手", "鈣超人"],
                answer: "纖維小助手",
                explanation: "纖維小助手是膳食纖維的化身，它像一把掃帚，清理腸道垃圾，促進排便順暢，預防便秘。同時，它也有助於穩定血糖和降低膽固醇，是維護心血管健康的隱形英雄！",
                character: "纖維小助手"
            },
            // 關於「晚上8點後進食一定會變胖」的迷思
            {
                question: "關於「晚上8點後進食一定會變胖」這個說法，以下哪個健康知識是正確的？",
                options: ["a) 晚上進食的熱量會被身體完全儲存為脂肪。", "b) 變胖與否主要取決於全天總熱量攝取與消耗的平衡。", "c) 晚上進食會降低新陳代謝速度，導致更容易發胖。", "d) 只要吃健康食物，晚上吃再多都不會變胖。"],
                answer: "b) 變胖與否主要取決於全天總熱量攝取與消耗的平衡。",
                explanation: "體重的增減主要取決於您一天攝取與消耗的總熱量平衡，而非特定的進食時間點。如果全天總熱量沒有超標，即使晚上吃東西也不會自動變胖。然而，睡前大量進食或高熱量食物可能會影響睡眠品質，並可能導致您在不知不經中攝取過多熱量。",
                character: "碘小精靈" // 間接關聯到新陳代謝
            },
            // 關於「排毒果汁或排毒茶可以幫助身體清除毒素」的迷思
            {
                question: "關於「排毒果汁或排毒茶可以幫助身體清除毒素」這個說法，以下哪個健康知識是正確的？",
                options: ["a) 這些產品能有效排出體內積累的所有毒素。", "b) 人體主要依靠肝臟衛士和腎臟衛士自然完成排毒功能。", "c) 排毒飲品可以取代均衡飲食來達到排毒效果。", "d) 只有透過排毒產品才能真正淨化身體。"],
                answer: "b) 人體主要依靠肝臟衛士和腎臟衛士自然完成排毒功能。",
                explanation: "人體擁有完善的自然排毒系統，主要由「肝臟衛士」和「腎臟衛士」負責處理和排出體內的廢物與毒素。均衡飲食、足夠水分攝取和規律運動是支持這些器官正常運作的最佳方式，而非依賴特定的排毒產品。",
                character: "肝臟衛士" // 連結到新的角色
            },
            // 新增的鐵質迷思題目
            {
                question: "關於鐵質攝取，以下哪個說法是正確的？",
                options: ["a) 只有吃紅肉才能補充鐵質。", "b) 蔬菜中的鐵質身體無法吸收。", "c) 維生素C可以幫助鐵質吸收。", "d) 貧血就是缺鐵，直接補充鐵劑就好。"],
                answer: "c) 維生素C可以幫助鐵質吸收。",
                explanation: "植物性鐵（非血基質鐵）的吸收率不如動物性鐵（血基質鐵），但搭配富含維生素C的食物（如柑橘類水果、芭樂）可以顯著提高其吸收率。缺鐵性貧血應由醫生診斷並指導補充，不應自行隨意補充鐵劑。",
                character: "鐵戰士"
            },
            // 新增的鈣質/維生素D迷思題目
            {
                question: "為了讓骨骼更強壯，除了攝取「鈣超人」，還需要哪位健康夥伴的幫助？",
                options: ["a) 鈉大俠", "b) 碘小精靈", "c) 維生素D寶寶", "d) 纖維小助手"],
                answer: "c) 維生素D寶寶",
                explanation: "維生素D寶寶是幫助身體吸收鈣質的關鍵。即使攝取足夠的鈣，如果缺乏維生素D，鈣也無法有效進入骨骼，長期可能導致骨質疏鬆。適量曬太陽是獲取維生素D的天然方式，也可以透過特定食物補充。",
                character: "維生素D寶寶"
            },
            // 新增的鈉質迷思題目
            {
                question: "為了減少「鈉大俠」攝取過多造成的影響，以下哪種做法最重要？",
                options: ["a) 多喝水就可以排出多餘的鈉。", "b) 避免加工食品和隱藏的鈉。", "c) 只要不加鹽的食物就沒有鈉。", "d) 多運動流汗就能排鈉。"],
                answer: "b) 避免加工食品和隱藏的鈉。",
                explanation: "許多加工食品、醬料、罐頭食品和外食中含有大量的隱藏鈉，即使嘗起來不鹹，也可能導致鈉攝取過量。單純多喝水或流汗對於排出體內過多鈉的效果有限，關鍵在於從源頭控制攝取總量。",
                character: "鈉大俠"
            },
            // 新增題目 12
            {
                question: "除了製造甲狀腺荷爾蒙，缺乏「碘小精靈」還會對兒童的哪方面產生嚴重影響？",
                options: ["a) 視力發展", "b) 智力發展", "c) 骨骼密度", "d) 肌肉力量"],
                answer: "b) 智力發展",
                explanation: "碘對於兒童的智力發展至關重要。孕婦或兒童期碘缺乏，可能導致不可逆轉的智力受損和生長遲緩。",
                character: "碘小精靈"
            },
            // 新增題目 13
            {
                question: "哪種食物通常含有大量的隱藏「鈉大俠」，即使嘗起來不鹹，也應注意適量攝取？",
                options: ["a) 新鮮水果", "b) 生鮮蔬菜", "c) 加工肉製品和罐頭食品", "d) 糙米和全麥麵包"],
                answer: "c) 加工肉製品和罐頭食品",
                explanation: "許多加工食品、醃製食品、罐頭食品和外食中含有大量的隱藏鈉。即使食物本身不鹹，也可能因為添加了含鈉的調味料或防腐劑而導致鈉攝取過量。",
                character: "鈉大俠"
            },
            // 新增題目 14
            {
                question: "除了平衡血壓，「鉀醫生」還對身體的哪兩個重要系統的正常功能至關重要？",
                options: ["a) 骨骼和消化", "b) 視力和聽力", "c) 心臟節律和肌肉收縮", "d) 肝臟和腎臟排毒"],
                answer: "c) 心臟節律和肌肉收縮",
                explanation: "鉀是維持正常心臟節律和肌肉收縮的關鍵電解質。它與鈉共同作用，維持細胞內外的電位平衡，對神經信號傳導也極為重要。",
                character: "鉀醫生"
            },
            // 新增題目 15
            {
                question: "「纖維小助手」在消化道中扮演了什麼主要角色，可以預防哪種常見的消化問題？",
                options: ["a) 吸收脂肪，預防高血壓", "b) 促進營養吸收，預防糖尿病", "c) 幫助腸道蠕動，預防便秘", "d) 分解蛋白質，預防胃潰瘍"],
                answer: "c) 幫助腸道蠕動，預防便秘",
                explanation: "膳食纖維雖然不能被消化吸收，但它能增加糞便體積，軟化糞便，刺激腸道蠕動，從而促進排便，有效預防便秘。同時，它也有助於維持腸道菌群健康。",
                character: "纖維小助手"
            },
            // 新增題目 16
            {
                question: "哪種生活習慣最能有效支持「肝臟衛士」的解毒功能，讓身體保持潔淨？",
                options: ["a) 每天飲用大量咖啡", "b) 均衡飲食、充足睡眠、避免過量飲酒", "c) 只吃單一種類的排毒食物", "d) 長時間不進食以排毒"],
                answer: "b) 均衡飲食、充足睡眠、避免過量飲酒",
                explanation: "肝臟是身體主要的解毒器官。支持肝臟健康的最佳方式是維持均衡飲食、攝取足夠的營養素、充足睡眠、規律運動，並避免過量飲酒和不必要的藥物負擔。",
                character: "肝臟衛士"
            },
            // 新增題目 17
            {
                question: "「腎臟衛士」除了過濾血液中的廢物，還能調節身體的哪項重要功能？",
                options: ["a) 體溫調節", "b) 免疫反應", "c) 水分和電解質平衡", "d) 荷爾蒙分泌"],
                answer: "c) 水分和電解質平衡",
                explanation: "腎臟不僅是身體的「淨水廠」，負責將血液中的代謝廢物（如尿素、肌酐酸）過濾並形成尿液排出，它還是維持身體水分、電解質（如鈉、鉀、鈣）和酸鹼平衡的關鍵器官。",
                character: "腎臟衛士"
            },
            // 新增題目 18
            {
                question: "為了提高植物性「鐵戰士」的吸收率，建議與哪種維生素一起攝取？",
                options: ["a) 維生素A", "b) 維生素B12", "c) 維生素C", "d) 維生素K"],
                answer: "c) 維生素C",
                explanation: "植物性食物中的鐵（非血基質鐵）較難被人體吸收，但若同時攝取富含維生素C的食物（如柑橘類水果、番石榴、甜椒），維生素C能將非血基質鐵轉化為更容易吸收的形式，顯著提高其吸收率。",
                character: "鐵戰士"
            },
            // 新增題目 19
            {
                question: "除了骨骼和牙齒，「鈣超人」還參與了身體的哪些重要生理功能？",
                options: ["a) 視力維持與夜間視力", "b) 血液凝固與肌肉收縮", "c) 血糖調節與能量代謝", "d) 頭髮生長與皮膚健康"],
                answer: "b) 血液凝固與肌肉收縮",
                explanation: "鈣不僅是骨骼和牙齒的主要成分，它在血液凝固、神經信號傳導、肌肉收縮（包括心肌）和細胞通訊等多種生理過程中都扮演著不可或缺的角色。",
                character: "鈣超人"
            },
            // 新增題目 20 (最後一題)
            {
                question: "獲取「維生素D寶寶」最天然、最主要的方式是什麼？",
                options: ["a) 飲用大量牛奶", "b) 適量曬太陽", "c) 食用大量綠葉蔬菜", "d) 透過飲用水補充"],
                answer: "b) 適量曬太陽",
                explanation: "人體皮膚在接受陽光（紫外線B）照射後，能夠自行合成維生素D。這是獲取維生素D最天然也是最主要的方式。飲食補充（如鮭魚、蛋黃、強化牛奶）是輔助手段。",
                character: "維生素D寶寶"
            }
        ];

        // Character definitions
        const characters = [
            {
                id: "碘小精靈",
                name: "碘小精靈",
                icon: "🧚",
                role: "甲狀腺荷爾蒙製造者",
                description: "我是身體裡新陳代謝的指揮官！主要負責製造甲狀腺荷爾蒙，這對你的生長發育、能量消耗和新陳代謝速度都非常重要。",
                deficiencySymptoms: "缺乏時可能導致甲狀腺功能不足（如甲狀腺腫大，俗稱大脖子病）、新陳代謝緩慢、疲倦、體重增加，兒童則會影響生長發育和智力發展。",
                sources: "主要來自海帶、海產和加碘鹽。",
                example: "💡 生活範例：就像家裡的恆溫器，我負責調節你身體的「溫度」和「節奏」。當我工作正常，你的精神會很好，不會感到總是疲倦或過度興奮。"
            },
            {
                id: "鈉大俠",
                name: "鈉大俠",
                icon: "🧚",
                role: "體液平衡與神經傳導者",
                description: "我是你身體裡不可或缺的電解質，幫忙維持細胞內外的水平衡、肌肉收縮和神經訊息傳遞。但請記住，凡事適量就好！",
                deficiencySymptoms: "雖然鈉缺乏較少見（除非大量出汗或嚴重腹瀉），但缺乏可能導致低血鈉症，症狀包括疲勞、頭痛、噁心、肌肉痙攣，嚴重時甚至引起腦水腫和昏迷。",
                sources: "主要來自食鹽和加工食品。",
                example: "💡 生活範例：我像身體裡的「水管工」，確保水流（體液）在正確的地方，壓力（血壓）也維持在穩定水平。但如果我太多，水管壓力就會過大喔！"
            },
            {
                id: "鉀醫生",
                name: "鉀醫生",
                icon: "🧚",
                role: "血壓平衡與心肌守護者",
                description: "我是「鈉大俠」的最佳拍檔，我們一起合作來保持你身體的液體和電解質平衡。我的特別任務是幫助身體排出多餘的鈉，這樣就能有效管理血壓，守護你的心臟健康！",
                deficiencySymptoms: "缺乏時可能導致低血鉀症，症狀包括肌肉無力、疲勞、心律不整、便秘，嚴重時可能影響心臟功能甚至危及生命。",
                sources: "主要來自新鮮蔬菜、水果（如香蕉）、全穀類和豆類。",
                example: "💡 生活範例：我是「鈉大俠」的煞車和平衡器！當鈉大俠想讓血壓升高時，我會跳出來幫助它降下來。我還是心臟跳動的「節拍器」，確保它規律工作。"
            },
            {
                id: "纖維小助手",
                name: "纖維小助手",
                icon: "🧚",
                role: "消化道清潔員與腸道守護者",
                description: "我是消化道的好幫手！雖然我不會被身體消化吸收，但能增加飽足感、幫助腸道蠕動，讓排便順暢，還能協助維持血糖和膽固醇的穩定喔！",
                deficiencySymptoms: "缺乏時最常見的症狀是便秘，長期缺乏可能增加罹患大腸癌、心血管疾病、糖尿病的風險。",
                sources: "主要來自蔬菜、水果、全穀類、豆類和堅果。",
                example: "💡 生活範例：我就像腸道裡的「清潔工」和「運輸車隊」。我把消化道裡的垃圾（廢物）掃出去，讓消化系統順暢運行，還能讓血糖和膽固醇像乘坐穩定的巴士一樣，不會突然飆高。"
            },
            // 新增的角色：肝臟衛士
            {
                id: "肝臟衛士",
                name: "肝臟衛士",
                icon: "🧚",
                role: "身體解毒大師",
                description: "我是你身體裡最重要的解毒器官！負責處理和分解來自食物、藥物和環境的各種有害物質。我的健康對你全身的排毒功能至關重要喔！",
                deficiencySymptoms: "肝臟功能受損的症狀多樣，包括疲勞、食慾不振、噁心、皮膚或眼睛發黃（黃疸）、尿液變深、皮膚瘙癢、容易瘀青等。",
                sources: "保持健康肝臟需均衡飲食、充足睡眠、避免過量飲酒和藥物濫用。",
                example: "💡 生活範例：我像是身體裡的「化學工廠」和「回收站」。我能把有害物質變成無害的，然後送出去。你的飲食、作息都會直接影響我的工作效率喔！"
            },
            // 新增的角色：腎臟衛士
            {
                id: "腎臟衛士",
                name: "腎臟衛士",
                icon: "🧚",
                role: "體液與廢物過濾器",
                description: "我是你身體裡的精密過濾器！負責過濾血液中的廢物，調節水分和電解質平衡，並生成尿液排出體外。我的正常運作確保身體內部環境的潔淨！",
                deficiencySymptoms: "腎臟功能不佳的早期症狀不明顯，後期可能出現水腫（尤其腳踝和眼睛周圍）、疲勞、尿量改變、食慾不振、噁心、皮膚瘙癢、高血壓等。",
                sources: "保持健康腎臟需足夠水分攝取、控制血壓血糖、避免高鹽高油飲食。",
                example: "💡 生活範例：我像是身體裡的「淨水廠」和「垃圾分類員」。我把血液中的髒東西過濾掉，然後把有用的水和養分留下來，確保你的身體裡總是乾淨的液體在循環。"
            },
            // 新增角色：鐵戰士
            {
                id: "鐵戰士",
                name: "鐵戰士",
                icon: "🧚",
                role: "氧氣運輸與能量製造者",
                description: "我是你身體裡的「氧氣運輸大隊長」！主要負責製造紅血球，將氧氣運送到身體各處，讓你充滿活力。",
                deficiencySymptoms: "缺乏時最常見的是缺鐵性貧血，症狀包括疲倦、臉色蒼白、頭暈、呼吸急促、心悸、手腳冰冷、指甲脆弱、掉髮等。",
                sources: "主要來自紅肉、豆類、深綠色蔬菜、堅果。",
                example: "💡 生活範例：我就像身體裡的「物流公司」，負責把氧氣這個重要的「貨物」送到每個細胞，讓它們充滿能量地運作。缺了我，你的細胞就「沒電」了！"
            },
            // 新增角色：鈣超人
            {
                id: "鈣超人",
                name: "鈣超人",
                icon: "🧚",
                role: "骨骼與牙齒的建造者",
                description: "我是你骨骼和牙齒的「超級建築師」！我的主要任務是讓你的骨頭強壯，牙齒堅固。此外，我還參與神經傳導、肌肉收縮和血液凝固等重要生理功能喔！",
                deficiencySymptoms: "兒童缺乏可能導致佝僂病，成人長期缺乏則易導致骨質疏鬆症，增加骨折風險。其他症狀還包括肌肉痙攣、抽筋、失眠、神經敏感等。",
                sources: "主要來自牛奶、乳製品、小魚乾、豆製品、深綠色蔬菜。",
                example: "💡 生活範例：我像是身體裡的「鋼筋混凝土」，沒有我，你的骨骼就像沒有支撐的房子，容易坍塌。我還是肌肉和神經的「開關」，沒有我，它們就無法正常工作。"
            },
            // 新增角色：維生素D寶寶
            {
                id: "維生素D寶寶",
                name: "維生素D寶寶",
                icon: "🧚",
                role: "鈣質吸收的推動者",
                description: "我是「鈣超人」的忠實夥伴！我的主要職責是幫助你的身體吸收鈣質，讓鈣超人能更好地發揮作用，共同維護骨骼健康。我也對免疫系統的正常運作有重要貢獻喔！",
                deficiencySymptoms: "缺乏時會影響鈣質吸收，導致骨骼軟化（兒童佝僂病，成人骨軟化症），增加骨質疏鬆和骨折風險。也可能影響免疫功能，增加感染風險，並與情緒、心血管疾病等有關。",
                sources: "主要來自日曬（身體自行合成）、鮭魚、蛋黃、乳製品（強化維生素D）。",
                範例: "💡 生活範例：我像是「鈣超人」的「專屬司機」和「超級嚮導」。沒有我，鈣超人就很難被你的身體吸收利用。我還能幫助你的免疫系統，就像是你的「貼身保鏢」！"
            }
        ];

        // Background Music Data (您可以替換這些音樂的 URL，並增加更多歌曲)
        const bgmSongsData = [
            { id: 'bgm-song1', name: 'Mortal funk', url: 'https://github.com/petroleum2024/heyyo/raw/main/Warriyo%2C%20LXNGVX%20-%20Mortals%20Funk%20Remix%20%5BNCS%20Release%5D.mp3' },
            { id: 'bgm-song2', name: '露比醬', url: 'https://github.com/petroleum2024/heyyo/raw/main/6%E6%9C%888%E6%97%A5.mp4' },
            { id: 'bgm-song3', name: '大展鴻圖', url: 'https://github.com/petroleum2024/heyyo/raw/main/6%E6%9C%888%E6%97%A5(2)%20-%20Compressed%20with%20FlexClip.mp4' }
        ];

        let score = 0;
        let currentQuestionIndex = 0;
        const screens = document.querySelectorAll('.screen');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const bgmSelector = document.getElementById('bgm-selector'); // New selector element
        const progressSlider = document.getElementById('progressSlider'); // New progress slider
        const currentTimeDisplay = document.getElementById('currentTimeDisplay'); // Current time display
        const durationDisplay = document.getElementById('durationDisplay'); // Total duration display

        let bgmAudioElements = new Map(); // To store actual audio elements (Audio objects)
        let currentBGM = null; // Reference to the currently playing background music Audio object

        // 音效元素變數
        let correctSFX;
        let incorrectSFX;

        const scoreDisplay = document.getElementById('score-display');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const feedbackResult = document.getElementById('feedback-result');
        const feedbackMessage = document.getElementById('feedback-message');
        const explanationDiv = document.getElementById('explanation');
        const finalScoreDisplay = document.getElementById('final-score');
        const characterListDiv = document.getElementById('character-list');
        const geminiExplanationContainer = document.getElementById('gemini-explanation-container');
        const geminiExplanationText = document.getElementById('gemini-explanation-text');
        const geminiLoadingSpinner = document.getElementById('gemini-loading');

        // Navigation buttons
        const prevQuestionNavBtn = document.getElementById('prev-question-nav-btn');
        const backToHomeFromQuestionBtn = document.getElementById('back-to-home-from-question-btn'); // New button
        const nextQuestionNavBtn = document.getElementById('next-question-nav-btn');
        const prevFeedbackNavBtn = document.getElementById('prev-feedback-nav-btn');
        const nextFeedbackNavBtn = document.getElementById('next-feedback-nav-btn'); // This button will become "查看分數"

        /**
         * Formats time in seconds into MM:SS format.
         * @param {number} seconds - The time in seconds.
         * @returns {string} Formatted time string.
         */
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes < 10 ? '0' : ''}${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
        }

        // Function to show a specific screen and hide others
        function showScreen(screenId) {
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            updateNavButtonsVisibility(); // Update button state when screen changes
        }

        // Initialize game or reset it
        function startGame() {
            score = 0;
            currentQuestionIndex = 0;
            updateScoreDisplay();
            showScreen('question-screen');
            displayQuestion();
        }

        // Display current question
        function displayQuestion() {
            if (currentQuestionIndex >= gameData.length) {
                endGame(); // If somehow currentQuestionIndex is out of bounds, go to end
                return;
            }

            // Reset Gemini explanation for the new question
            geminiExplanationContainer.style.display = 'none';
            geminiExplanationText.textContent = '';
            geminiLoadingSpinner.style.display = 'none';

            const question = gameData[currentQuestionIndex];
            questionText.textContent = `第 ${currentQuestionIndex + 1} 題: ${question.question}`; // Add question number
            optionsContainer.innerHTML = ''; // Clear previous options

            // Enable all option buttons
            optionsContainer.querySelectorAll('.option-btn').forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('correct', 'incorrect');
            });

            const isLastQuestion = (currentQuestionIndex === gameData.length - 1);

            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.classList.add('option-btn');
                button.textContent = option;
                button.onclick = () => checkAnswer(option, isLastQuestion); // Pass isLastQuestion to checkAnswer
                optionsContainer.appendChild(button);
            });

            // Add '交卷' button only for the last question
            if (isLastQuestion) {
                const submitButton = document.createElement('button');
                submitButton.classList.add('submit-btn');
                submitButton.textContent = '交卷';
                submitButton.onclick = () => submitQuiz();
                optionsContainer.appendChild(submitButton);
            }

            updateNavButtonsVisibility(); // Update button state after question display
        }

        // Check the selected answer
        function checkAnswer(selectedOption, isLastQuestion = false) {
            const question = gameData[currentQuestionIndex];
            const isCorrect = (selectedOption === question.answer);

            // Disable all option buttons
            Array.from(optionsContainer.children).forEach(btn => {
                btn.disabled = true;
                if (btn.classList.contains('submit-btn')) { // Keep submit button active if not clicked directly
                   btn.disabled = false;
                }
            });

            // Highlight chosen option and correct answer
            Array.from(optionsContainer.children).forEach(btn => {
                if (btn.textContent === selectedOption) {
                    btn.classList.add(isCorrect ? 'correct' : 'incorrect');
                } else if (btn.textContent === question.answer) {
                    btn.classList.add('correct'); // Show correct answer even if incorrect was chosen
                }
            });


            if (isCorrect) {
                score++;
                feedbackResult.textContent = "答對了！🎉";
                feedbackResult.classList.remove('text-red-600');
                feedbackResult.classList.add('text-green-600');
                feedbackMessage.textContent = "你對健康知識的理解很棒！";
                if (correctSFX) {
                    correctSFX.pause(); // 暫停並重置，確保每次從頭播放
                    correctSFX.currentTime = 0;
                    correctSFX.play();
                }

                // Display explanation - ONLY for the correct answer
                const correctCharacter = characters.find(char => char.id === question.character);
                explanationDiv.innerHTML = `
                    <p><strong><span class="character-icon">${correctCharacter ? correctCharacter.icon : ''}</span>關於正確答案的解釋：</strong></p>
                    <p>${question.explanation}</p>
                    ${correctCharacter ? `<p class="mt-2 text-sm text-gray-600"><strong>${correctCharacter.example}</strong></p>` : ''}
                    ${correctCharacter ? `<p class="text-sm mt-2 text-gray-600"><strong>來源：</strong>${correctCharacter.sources}</p>` : ''}
                    ${correctCharacter && correctCharacter.deficiencySymptoms ? `<p class="text-sm mt-2 font-semibold text-red-700"><strong>缺乏時可能導致的症狀：</strong>${correctCharacter.deficiencySymptoms}</p>` : ''}
                `;

            } else { // User answered incorrectly
                // score remains unchanged if incorrect (no deduction)
                feedbackResult.textContent = "答錯了... 😢";
                feedbackResult.classList.remove('text-green-600');
                feedbackResult.classList.add('text-red-600');
                feedbackMessage.textContent = `正確答案是：${question.answer}`;
                if (incorrectSFX) {
                    incorrectSFX.pause(); // 暫停並重置，確保每次從頭播放
                    incorrectSFX.currentTime = 0;
                    incorrectSFX.play();
                }

                // Clear previous explanation content
                explanationDiv.innerHTML = '';

                // Get the character related to the correct answer for its explanation
                const correctCharacter = characters.find(char => char.id === question.character);

                // Try to find if the selected option corresponds to a character
                const selectedCharacter = characters.find(char => selectedOption.includes(char.name));

                // Section for the INCORRECTLY chosen option/character
                if (selectedCharacter) {
                    explanationDiv.innerHTML += `
                        <p class="text-lg font-semibold text-red-700 mt-4">你選擇的答案：「${selectedOption}」</p>
                        <p><strong><span class="character-icon">${selectedCharacter.icon}</span>${selectedCharacter.name} 的作用：</strong></p>
                        <p>${selectedCharacter.description}</p>
                        <p class="mt-2 text-sm text-gray-600"><strong>${selectedCharacter.example}</strong></p>
                        <p class="text-sm mt-2 text-gray-600"><strong>來源：</strong>${selectedCharacter.sources}</p>
                        ${selectedCharacter.deficiencySymptoms ? `<p class="text-sm mt-2 font-semibold text-red-700"><strong>缺乏時可能導致的症狀：</strong>${selectedCharacter.deficiencySymptoms}</p>` : ''}
                    `;
                } else {
                    // If the selected option is NOT a character name (e.g., from a myth question)
                    explanationDiv.innerHTML += `
                        <p class="text-lg font-semibold text-red-700 mt-4">你選擇的答案：</p>
                        <p class="font-medium text-gray-700">「${selectedOption}」</p>
                        <p class="text-sm text-gray-600 mt-2">這個選項不符合正確的健康知識。請看下方正確的解釋。</p>
                    `;
                }

                // Section for the CORRECT answer's explanation
                explanationDiv.innerHTML += `
                    <p class="text-lg font-semibold text-green-700 mt-4">正確答案的解釋：</p>
                    <p>${question.explanation}</p>
                    ${correctCharacter ? `<p class="mt-2 text-sm text-gray-600"><strong>${correctCharacter.example}</strong></p>` : ''}
                    ${correctCharacter ? `<p class="text-sm mt-2 text-gray-600"><strong>來源：</strong>${correctCharacter.sources}</p>` : ''}
                    ${correctCharacter && correctCharacter.deficiencySymptoms ? `<p class="text-sm mt-2 font-semibold text-green-700"><strong>缺乏時可能導致的症狀：</strong>${correctCharacter.deficiencySymptoms}</p>` : ''}
                `;
            }

            // ALWAYS show feedback screen
            showScreen('feedback-screen');
        }

        // Function to handle quiz submission
        function submitQuiz() {
            // This function is called when the '交卷' button is clicked.
            // If the user clicks '交卷' without selecting an option on the last question,
            // we will simulate an incorrect answer to show the feedback screen.
            const options = Array.from(optionsContainer.children).filter(btn => btn.classList.contains('option-btn'));
            const anyOptionSelected = options.some(btn => btn.classList.contains('correct') || btn.classList.contains('incorrect'));

            if (!anyOptionSelected) { // If no option was selected, treat as unanswered/incorrect
                // Simulate checking an "empty" answer for the last question to ensure feedback is shown
                // The current question index is already at the last question.
                checkAnswer("未作答", true);
            } else {
                // If an option was already selected, checkAnswer would have already been called
                // and showScreen('feedback-screen') would have been executed.
                // So, we don't need to do anything here as the user is already on the feedback screen.
            }
        }


        // Function to call Gemini API for more info
        async function learnMore() {
            const currentQuestion = gameData[currentQuestionIndex];
            const characterName = currentQuestion.character;
            // The topic for Gemini should be the character's role and name for a better explanation
            const characterInfo = characters.find(char => char.id === characterName);
            const promptTopic = `${characterInfo.name} (${characterInfo.role})`;

            // Display loading spinner and clear previous text
            geminiExplanationContainer.style.display = 'block';
            geminiExplanationText.textContent = '生成中...';
            geminiLoadingSpinner.style.display = 'inline-block';

            let chatHistory = [];
            const prompt = `請用繁體中文，以易於理解的方式，針對「${promptTopic}」在人體中的作用及其重要性，提供更深入的健康知識解說。解釋內容約100-150字。`;
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // If you want to use models other than gemini-2.0-flash or imagen-3.0-generate-002, provide an API key here. Otherwise, leave this as-is.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    geminiExplanationText.textContent = text;
                } else {
                    geminiExplanationText.textContent = '無法生成更多資訊，請稍後再試。';
                    console.error('Gemini API response format unexpected:', result);
                }
            } catch (error) {
                geminiExplanationText.textContent = '生成失敗，請檢查網路或稍後再試。';
                console.error('Error calling Gemini API:', error);
            } finally {
                geminiLoadingSpinner.style.display = 'none'; // Hide spinner
            }
        }


        // Move to the next question (from feedback screen or skipping from question screen)
        function nextQuestion() {
            const isLastQuestion = (currentQuestionIndex === gameData.length - 1);
            if (isLastQuestion) {
                endGame(); // If it's the last question, go to end screen
            } else {
                currentQuestionIndex++;
                displayQuestion();
                showScreen('question-screen');
            }
        }

        // Function to skip to next question without answering (from question screen nav button)
        function skipToNextQuestion() {
            // No score change, just move to next question
            nextQuestion();
        }

        // Move to the previous question
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
                showScreen('question-screen');
            }
            // No need to call updateNavButtonsVisibility here, it's called in displayQuestion and showScreen
        }

        // Update visibility and disabled state of navigation buttons
        function updateNavButtonsVisibility() {
            const isFirstQuestion = (currentQuestionIndex === 0);
            const isLastQuestion = (currentQuestionIndex === gameData.length - 1);
            // const isFeedbackScreenActive = document.getElementById('feedback-screen').classList.contains('active'); // Not directly used in decision logic here anymore

            // Question Screen Nav Buttons
            if (prevQuestionNavBtn) {
                prevQuestionNavBtn.disabled = isFirstQuestion;
            }
            if (nextQuestionNavBtn) {
                // If it's the last question, the "Next" button should be disabled as "交卷" takes over.
                // Otherwise, it should be enabled.
                nextQuestionNavBtn.disabled = isLastQuestion;
            }

            // Feedback Screen Nav Buttons
            if (prevFeedbackNavBtn) {
                prevFeedbackNavBtn.disabled = isFirstQuestion;
            }
            if (nextFeedbackNavBtn) {
                // Only show "查看分數" if we are on the feedback screen AND it's the last question.
                if (document.getElementById('feedback-screen').classList.contains('active') && isLastQuestion) {
                    nextFeedbackNavBtn.textContent = '查看分數';
                    nextFeedbackNavBtn.classList.add('view-score-btn'); // Add specific style
                    nextFeedbackNavBtn.classList.remove('nav-btn'); // Remove generic style
                    // When it's the last question on feedback screen, the button leads to endGame
                    nextFeedbackNavBtn.onclick = endGame;
                } else {
                    nextFeedbackNavBtn.textContent = '下一題 &#x25B6;';
                    nextFeedbackNavBtn.classList.add('nav-btn'); // Add generic style
                    nextFeedbackNavBtn.classList.remove('view-score-btn'); // Remove specific style
                    // When it's not the last question on feedback screen, the button leads to nextQuestion
                    nextFeedbackNavBtn.onclick = nextQuestion;
                }
                nextFeedbackNavBtn.disabled = false; // Always enabled to allow moving from feedback or viewing score
            }
        }


        // End game and show final score
        function endGame() {
            finalScoreDisplay.textContent = `你的總分是：${score} / ${gameData.length}`;
            showScreen('end-screen');
        }

        // Reset game for replay
        function resetGame() {
            startGame();
        }

        // Update score display
        function updateScoreDisplay() {
            scoreDisplay.textContent = `得分：${score}`;
        }

        // Render character info screen
        function renderCharactersScreen() {
            characterListDiv.innerHTML = ''; // Clear previous characters
            characters.forEach(char => {
                const card = document.createElement('div');
                card.classList.add('character-card');
                card.innerHTML = `
                    <h3 class="flex items-center"><span class="character-icon">${char.icon}</span> ${char.name}</h3>
                    <p class="role">${char.role}</p>
                    <p>${char.description}</p>
                    <p class="text-sm mt-2 font-semibold text-gray-700"><strong>${char.example}</strong></p>
                    <p class="text-sm mt-2 text-gray-600"><strong>來源：</strong>${char.sources}</p>
                    <p class="text-sm mt-2 font-semibold text-red-700"><strong>缺乏時可能導致的症狀：</strong>${char.deficiencySymptoms}</p>
                `;
                characterListDiv.appendChild(card);
            });
            showScreen('characters-screen');
        }

        // Initial screen display and event listeners setup
        document.addEventListener('DOMContentLoaded', () => {
            // Get audio elements
            correctSFX = document.getElementById('correct-sfx');
            incorrectSFX = document.getElementById('incorrect-sfx');

            // Initialize background music audio elements
            bgmSongsData.forEach(song => {
                const audio = document.getElementById(song.id); // Get pre-existing audio element from HTML
                if (!audio) { // Fallback if audio element not found (shouldn't happen with current HTML)
                    console.warn(`Audio element with ID ${song.id} not found, creating new Audio object.`);
                    const newAudio = new Audio(song.url);
                    newAudio.loop = true;
                    bgmAudioElements.set(song.id, newAudio);
                } else {
                    audio.loop = true; // Ensure loop is set
                    bgmAudioElements.set(song.id, audio);
                }

                // Populate the dropdown
                const option = document.createElement('option');
                option.value = song.id;
                option.textContent = song.name;
                bgmSelector.appendChild(option);
            });

            // Set initial background music to the first song in the list
            currentBGM = bgmAudioElements.get(bgmSongsData[0].id);
            if (currentBGM) {
                volumeSlider.value = currentBGM.volume; // Set slider to current BGM volume (default 1.0)
                // Attempt to play music, handle autoplay policy
                const playPromise = currentBGM.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        playPauseBtn.textContent = '❚❚ 暫停';
                    }).catch(error => {
                        console.log("Autoplay was prevented. User interaction is needed to play music.");
                        playPauseBtn.textContent = '▶ 播放';
                    });
                }
            } else {
                 playPauseBtn.textContent = '▶ 播放'; // No BGM, default to play
            }


            showScreen('start-screen');
            updateNavButtonsVisibility();

            // Event Listeners
            document.getElementById('startGameBtn').addEventListener('click', startGame);
            document.getElementById('renderCharactersBtn').addEventListener('click', renderCharactersScreen);
            document.getElementById('backToHomeFromCharacters').addEventListener('click', () => showScreen('start-screen'));
            document.getElementById('prev-question-nav-btn').addEventListener('click', previousQuestion);
            document.getElementById('back-to-home-from-question-btn').addEventListener('click', () => {
                showScreen('start-screen');
                // Optionally pause music when returning to home if it was playing a quiz BGM
                if (currentBGM && !currentBGM.paused) {
                    currentBGM.pause();
                    playPauseBtn.textContent = '▶ 播放';
                }
            });
            document.getElementById('next-question-nav-btn').addEventListener('click', skipToNextQuestion);
            document.getElementById('learnMoreBtn').addEventListener('click', learnMore);
            document.getElementById('prev-feedback-nav-btn').addEventListener('click', previousQuestion);
            // next-feedback-nav-btn's function is dynamic, so keep setting it in updateNavButtonsVisibility
            document.getElementById('resetGameBtn').addEventListener('click', resetGame);
            document.getElementById('backToHomeFromEnd').addEventListener('click', () => showScreen('start-screen'));

            // Audio control event listeners
            playPauseBtn.addEventListener('click', () => {
                if (currentBGM) {
                    if (currentBGM.paused) {
                        currentBGM.play();
                        playPauseBtn.textContent = '❚❚ 暫停';
                    } else {
                        currentBGM.pause();
                        playPauseBtn.textContent = '▶ 播放';
                    }
                }
            });

            volumeSlider.addEventListener('input', () => {
                if (currentBGM) {
                    currentBGM.volume = volumeSlider.value;
                }
            });

            // New: Song selection
            bgmSelector.addEventListener('change', (event) => {
                const selectedSongId = event.target.value;
                if (currentBGM) {
                    currentBGM.pause(); // Pause current song
                    // Remove timeupdate and ended listeners from previous BGM
                    currentBGM.removeEventListener('timeupdate', updateProgress);
                    currentBGM.removeEventListener('ended', handleSongEnded);
                    currentBGM.removeEventListener('loadedmetadata', setupProgressBar);
                }

                // Reset progress display immediately when a new song is selected
                progressSlider.value = 0;
                currentTimeDisplay.textContent = '00:00';
                durationDisplay.textContent = '00:00'; // Reset duration as well

                currentBGM = bgmAudioElements.get(selectedSongId); // Set new current song

                // Add timeupdate and ended listeners to the new BGM
                if (currentBGM) {
                    currentBGM.volume = volumeSlider.value; // Apply current volume setting
                    currentBGM.addEventListener('timeupdate', updateProgress);
                    currentBGM.addEventListener('loadedmetadata', setupProgressBar); // Set up progress bar when metadata loads
                    currentBGM.addEventListener('ended', handleSongEnded); // Handle when song ends (though loop is on)
                    
                    // Attempt to play, handling potential autoplay restrictions
                    currentBGM.play().then(() => {
                        playPauseBtn.textContent = '❚❚ 暫停';
                    }).catch(error => {
                        console.log("Failed to play selected song automatically. User interaction needed.");
                        playPauseBtn.textContent = '▶ 播放'; // Keep button in play state if blocked
                    });

                    // Call setupProgressBar immediately in case metadata is already loaded (e.g., from cache)
                    // This ensures the duration and initial current time are set correctly for the new song
                    setupProgressBar();
                }
            });

            // Progress bar and time display logic
            function updateProgress() {
                if (currentBGM) {
                    const progress = currentBGM.currentTime;
                    progressSlider.value = progress;
                    currentTimeDisplay.textContent = formatTime(progress);
                }
            }

            function setupProgressBar() {
                if (currentBGM && !isNaN(currentBGM.duration)) { // Check if duration is a valid number
                    progressSlider.max = currentBGM.duration;
                    progressSlider.value = currentBGM.currentTime;
                    durationDisplay.textContent = formatTime(currentBGM.duration);
                    currentTimeDisplay.textContent = formatTime(currentBGM.currentTime);
                } else {
                    // Reset if duration is not available (e.g., audio not loaded yet)
                    progressSlider.max = 0;
                    progressSlider.value = 0;
                    durationDisplay.textContent = '00:00';
                    currentTimeDisplay.textContent = '00:00';
                }
            }

            function handleSongEnded() {
                // If loop is true, this won't fire. But good to have for consistency.
                playPauseBtn.textContent = '▶ 播放';
                progressSlider.value = 0;
                currentTimeDisplay.textContent = '00:00';
            }

            // Event listener for progress slider (user seeking)
            progressSlider.addEventListener('input', () => {
                if (currentBGM) {
                    // Only seek if the audio has duration and is not paused by the browser's initial autoplay block
                    // or if it has started playing at least once.
                    if (!isNaN(currentBGM.duration) && currentBGM.readyState >= 1) { // readyState 1 means metadata is available
                        currentBGM.currentTime = progressSlider.value;
                        currentTimeDisplay.textContent = formatTime(currentBGM.currentTime);
                    }
                }
            });

            // Attach initial listeners for the first BGM if it exists
            if (currentBGM) {
                currentBGM.addEventListener('timeupdate', updateProgress);
                currentBGM.addEventListener('loadedmetadata', setupProgressBar);
                currentBGM.addEventListener('ended', handleSongEnded);
            }

            // Initial setup for progress bar display
            setupProgressBar();
        });
    </script>
</body>
</html>
